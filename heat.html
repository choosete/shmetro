<!DOCTYPE html>
<html>

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <!--<meta http-equiv="X-UA-Compatible" content="IE=EmulateIE8"/>-->
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    <meta name="viewport" content="width=device-width,maximum-scale=1.0, minimum-scale=1.0">
    <!-- <link rel="stylesheet" type="text/css" href="http://marketing.cyberspaceit.cn/interface/metromap/css/style.css">
    <link rel="stylesheet" type="text/css" href="http://marketing.cyberspaceit.cn/interface/metromap/css/map.css"> -->
    <link rel="stylesheet" type="text/css"
        href="http://marketing.cyberspaceit.cn/interface/metromap/mapplic/mapplic.css">
    <!-- <link rel="stylesheet" type="text/css" href="http://service.shmetro.com/skin/css/yunyingline.css">
    </link> -->
    <!-- <link href="http://service.shmetro.com/skin/css/rpresult.css" rel="stylesheet" type="text/css" /> -->

    <link rel="stylesheet" href="./assets/custom.css">

    <script src="./process.js"></script>

    <script src="./utils/lib.js"></script>

    <head>

    <body>

        <!-- svg容器 -->
        <div id="mapplic"></div>
        <!-- <div id="accessNull"></div> -->

        <!-- 线路图脚本部分 Scripts -->
        <script type="text/javascript" src="./assets/jquery.min.js"></script>
        <!-- <script type="text/javascript"
                src="http://marketing.cyberspaceit.cn/interface/metromap/js/hammer.min.js"></script> -->
        <script type="text/javascript"
            src="http://marketing.cyberspaceit.cn/interface/metromap/js/jquery.easing.js"></script>
        <script type="text/javascript"
            src="http://marketing.cyberspaceit.cn/interface/metromap/js/jquery.mousewheel.js"></script>
        <script type="text/javascript"
            src="http://marketing.cyberspaceit.cn/interface/metromap/js/smoothscroll.js"></script>
        <script type="text/javascript" src="./assets/mapplic.js"></script>
        <script type="text/javascript"
            src="http://marketing.cyberspaceit.cn/interface/metromap/js/snap.svg-min.js"></script>
        <script type="text/javascript">

            $(document).ready(function () {

                // 在页面内生成svg地铁图
                $('#mapplic').mapplic({
                    source: './assets/metromap.json', // 地铁站点位置信息
                    selector: 'g > [id^=\'ST\']',
                    // height: 1000, // svg 容器的高度
                    height: '100vh',
                    animate: false,
                    sidebar: false, // 左侧边的搜索栏 - 站名搜索
                    minimap: false,
                    locations: true,
                    deeplinking: true,
                    fullscreen: true,
                    hovertip: false,
                    developer: false,
                    zoom: true,
                });

                function createSVGELE(tag, attrs = {}) {
                    const ele = document.createElementNS('http://www.w3.org/2000/svg', tag)
                    for (let key in attrs) {
                        if (key === "style") {
                            let styleObj = attrs['style']
                            let val = "";
                            Object.keys(styleObj).forEach(key => {
                                val += key + ":" + styleObj[key] + ";"
                            })
                            ele.setAttribute('style', val)
                        } else {
                            ele.setAttribute(key, attrs[key])
                        }

                    }
                    return ele
                }

                // 地铁线路设置渐变色
                $('#mapplic').on('loaded', function () {

                    // 地铁线全部置灰
                    $('[id^=segment]').css({ stroke: '#142f3a' })

                    // 1号线为例 window.mapJSON
                    // $('g[id=layer1]').children('path').css({stroke: '#8cc220'})
                    const data = window.mapJSON['line01'];
                    const defs = createSVGELE('defs', {
                        id: `linearGradient_line01`
                    })
                    $(`g[id=line01]`).append(defs)

                    Object.keys(data.subways).forEach(seg => {

                        const path = $(`[id=${seg}]`).get(0)

                        //获取segment的方向，横1，竖2, 决定渐变方向，简化处理，水平或者垂直两种
                        const svgRect = path.getBBox()
                        const flag = svgRect.height < 2 ? 1 : 2

                        // 两个端点的坐标值应该取 这段站的两个站点位置
                        const st = document.getElementById(data.subways[seg].st)
                        const ed = document.getElementById(data.subways[seg].ed)

                        const { x: x1, y: y1 } = getCenterPos(st)
                        const { x: x2, y: y2 } = getCenterPos(ed)

                        const linearGradient = createSVGELE('linearGradient', {
                            id: `linearGradient_${seg}`,
                            gradientUnits: 'userSpaceOnUse',
                            x1,
                            y1,
                            x2,
                            y2
                        })
                        linearGradient.appendChild(createSVGELE('stop', {
                            // offset="0%" style="stop-color:rgb(255,255,0);stop-opacity:1"
                            offset: '0%',
                            style: {
                                'stop-color': 'rgb(255,255,0)',
                            }
                        }))
                        linearGradient.appendChild(createSVGELE('stop', {
                            // offset="0%" style="stop-color:rgb(255,255,0);stop-opacity:1"
                            offset: '100%',
                            style: {
                                'stop-color': 'rgb(255,0,0)',
                            }
                        }))

                        defs.appendChild(linearGradient)

                        path.style.stroke = `url(#linearGradient_${seg})`
                        // path.setAttribute('stroke', `url(#linearGradient_${seg})`)


                    })


                })

            })


        </script>
    </body>

</html>